<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>AEW Tracks 1995 – Interactive Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body{margin:0;padding:0;font-family:Arial,sans-serif;}
    #map{width:100vw;height:100vh;}
    .control{background:white;padding:12px;border-radius:6px;box-shadow:0 3px 12px rgba(0,0,0,0.3);font-size:15px;}
    select{width:100%;padding:8px;font-size:15px;border-radius:4px;}
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ------------------------------------------------------------
// Smart JSON loader: works with http server AND file:// (double-click)
// ------------------------------------------------------------
let geojsonData = null;

function loadJSON() {
  // 1. Try normal fetch first (works when served via python server)
  fetch('aew_tracks_1995_interactive.json?' + Date.now())  // cache buster
    .then(r => {
      if (r.ok) return r.json();
      throw new Error('fetch failed');
    })
    .then(data => {
      geojsonData = data;
      initMap();
    })
    .catch(() => {
      // 2. Fallback: read from embedded <script id="aewdata"> for offline/double-click use
      const el = document.getElementById('aewdata');
      if (el && el.textContent.trim()) {
        try {
          geojsonData = JSON.parse(el.textContent);
          console.log("Loaded JSON from embedded script (offline mode)");
          initMap();
        } catch (e) {
          alert("Embedded JSON is invalid. Paste the full content of aew_tracks_1995_interactive.json into the <script id=\"aewdata\"> tag.");
        }
      } else {
        alert("Could not load aew_tracks_1995_interactive.json\n\n• Using python -m http.server? Make sure the file is in the same folder\n• Double-clicking the HTML? Paste the JSON into the <script id=\"aewdata\"> tag below");
      }
    });
}

// ------------------------------------------------------------
// Plasma_r color scale
// ------------------------------------------------------------
function strengthToColor(v) {
  const min = 0.2, max = 1.6;
  const t = Math.max(0, Math.min(1, (v - min)/(max - min)));
  const colors = ["#0d0887","#350498","#5b0ba6","#800fb2","#a42ab9","#c43ec0","#db5cbb","#ed82b8","#fca7b8","#fed6bc","#f9f9b6","#f0f9a9"];
  return colors[Math.floor(t * (colors.length-1))];
}

// ------------------------------------------------------------
// Draw one track with per-segment coloring
// ------------------------------------------------------------
function drawGraduatedTrack(feature, layerGroup) {
  const coords = feature.geometry.coordinates;
  const points = feature.properties.point_data;

  for (let i = 0; i < coords.length - 1; i++) {
    const segment = L.polyline(
      [[coords[i][1], coords[i][0]], [coords[i+1][1], coords[i+1][0]]],
      { color: strengthToColor(points[i].strength), weight: 4.8, opacity: 0.94 }
    )
    .addTo(layerGroup)
    .bindPopup(`
      <b>AEW System ${feature.properties.system_id}</b><br>
      Mean strength: ${feature.properties.strength_mean.toFixed(3)}<br>
      Range: ${feature.properties.strength_min.toFixed(3)} – ${feature.properties.strength_max.toFixed(3)}<br>
      Points: ${feature.properties.track_length_points}<br>
      Months: ${feature.properties.months.sort((a,b)=>a-b).join(', ')}
    `);
  }
}

// ------------------------------------------------------------
// Map setup
// ------------------------------------------------------------
let trackGroup;
function initMap() {
  const map = L.map('map').setView([15, -20], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  trackGroup = L.layerGroup().addTo(map);

  function render(month = 'all') {
    trackGroup.clearLayers();
    geojsonData.features.forEach(f => {
      if (month !== 'all' && !f.properties.months.includes(Number(month))) return;
      drawGraduatedTrack(f, trackGroup);
    });
    if (trackGroup.getLayers().length) map.fitBounds(trackGroup.getBounds().pad(0.2));
  }

  // Month filter
  const monthName = {6:"June",7:"July",8:"August",9:"September",10:"October"};
  let html = '<div style="margin-bottom:8px"><strong>Filter by month</strong></div><select id="monthfilter">';
  html += '<option value="all">All months (Jun–Oct)</option>';
  [6,7,8,9,10].forEach(m => html += `<option value="${m}">${monthName[m]} 1995</option>`);
  html += '</select>';

  L.control({position:'topright'}).onAdd = function() {
    const div = L.DomUtil.create('div', 'control');
    div.innerHTML = html;
    L.DomEvent.disableClickPropagation(div);
    div.querySelector('#monthfilter').addEventListener('change', e => render(e.target.value));
    return div;
  }.addTo(map);

  render();
}

// ------------------------------------------------------------
// Start loading
// ------------------------------------------------------------
loadJSON();
</script>

<!-- Optional: paste your JSON here only if you want pure offline double-click mode -->
<script type="application/json" id="aewdata">
</script>

</body>
</html>