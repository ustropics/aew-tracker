<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AEW Tracks 1995 - 700hPa Curvature Vorticity</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

  <style>
    body { margin:0; padding:0; font-family: Arial, sans-serif; }
    #map { width:100vw; height:100vh; }
    .control-panel {
      position: absolute; top: 12px; left: 12px; z-index: 1000;
      background: rgba(255,255,255,0.94); padding: 14px 16px;
      border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.5);
      font-size: 14px; backdrop-filter: blur(6px);
    }
    select, button { padding: 7px 11px; margin: 4px; border-radius: 5px; border: none;
      background: #333; color: #fff; cursor: pointer; }
    button:hover { background: #555; }
    .checkbox-label { display: block; margin-top: 10px; font-size: 13px; }
    .checkbox-label input { margin-right: 8px; transform: scale(1.2); cursor: pointer; }

    .legend {
      position: absolute; bottom: 20px; left: 12px; z-index: 1000;
      background: rgba(255,255,255,0.94); padding: 14px 16px;
      border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.5);
      font-size: 13px; backdrop-filter: blur(6px);
      width: 380px;
    }
    .legend-title {
      font-weight: bold; text-align: center; margin-bottom: 8px; font-size: 13.5px;
    }
    .color-bar {
      width: 100%; height: 22px; border-radius: 5px; margin: 10px 0;
      background: linear-gradient(to right,
        #1c54ff, #6cc343, #ffc309, #ff7209, #e83b0c, #e80cae, #bd00ff
      );
      border: 1px solid #aaa; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    .color-bar-labels {
      display: flex; justify-content: space-between;
      font-size: 12px; font-weight: bold; color: #333;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div class="control-panel">
  <strong>AEW Tracks 1995</strong><br>
  <label>Month:</label>
  <select id="monthFilter">
    <option value="all">All Months</option>
    <option value="6">June</option>
    <option value="7">July</option>
    <option value="8" selected>August</option>
    <option value="9">September</option>
    <option value="10">October</option>
  </select>
  <button onclick="applyFilters()">Apply</button>
  <button onclick="clearFilters()">Clear</button>

  <label class="checkbox-label">
    <input type="checkbox" id="showPointsOnly" onchange="applyFilters()">
    Show points only (hide lines)
  </label>

  <div style="margin-top:8px;">Tracks: <strong id="trackCount">Loading data...</strong></div>
</div>

<div class="legend">
  <div class="legend-title">
    Measured by 700hPa Curvature Vorticity (×10⁻⁵ s⁻¹)
  </div>
  <div class="color-bar"></div>
  <div class="color-bar-labels">
    <span>0</span>
    <span>3.5</span>
    <span>7</span>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
// Map + dark basemap
const map = L.map('map').setView([12, -20], 4);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '© OpenStreetMap contributors © CARTO',
  subdomains: 'abcd', maxZoom: 20
}).addTo(map);

// Saffir-Simpson style color scale
function getColor(strength_x1e5) {
  if (strength_x1e5 <= 1.5) return '#1c54ff';
  if (strength_x1e5 <= 3.0) return '#6cc343';
  if (strength_x1e5 <= 4.2) return '#ffc309';
  if (strength_x1e5 <= 5.0) return '#ff7209';
  if (strength_x1e5 <= 5.8) return '#e83b0c';
  if (strength_x1e5 <= 6.5) return '#e80cae';
  return '#bd00ff';
}

const trackLayer = L.layerGroup().addTo(map);
let allFeatures = [];
let dataLoaded = false;
let currentHighlighted = null;

// Load JSON with proper error handling
fetch('aew_tracks_1995_interactive.json')
  .then(r => {
    if (!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}`);
    return r.json();
  })
  .then(data => {
    allFeatures = data.features || [];
    dataLoaded = true;
    document.getElementById('trackCount').textContent = `${allFeatures.length} tracks loaded`;
    applyFilters(); // First draw
  })
  .catch(err => {
    console.error('JSON load failed:', err);
    document.getElementById('trackCount').textContent = 'Failed to load data – check file path';
    dataLoaded = false;
  });

function trackPassesFilter(f, month) {
  return month === 'all' || f.properties.months.includes(parseInt(month));
}

function updateMap() {
  trackLayer.clearLayers();
  currentHighlighted = null;

  if (!dataLoaded || allFeatures.length === 0) {
    document.getElementById('trackCount').textContent = 'No data available';
    return;
  }

  const month = document.getElementById('monthFilter').value;
  const pointsOnly = document.getElementById('showPointsOnly').checked;
  const visible = allFeatures.filter(f => trackPassesFilter(f, month));

  if (visible.length === 0) {
    document.getElementById('trackCount').textContent = '0 tracks (filtered)';
    return;
  }

  visible.forEach(feature => {
    const coords = feature.geometry.coordinates;
    const points = feature.properties.point_data;
    const layers = [];

    if (pointsOnly) {
      points.forEach((pt, i) => {
        const s = pt.strength * 1e5;
        const circle = L.circleMarker([coords[i][1], coords[i][0]], {
          radius: 7,
          color: 'transparent',
          weight: 0,
          fillColor: getColor(s),
          fillOpacity: 0.98
        }).bindTooltip(
          `<strong>AEW Position</strong><br>Date: ${pt.time.split(' ')[0]}<br>700hPa Curvature Vorticity: <strong>${s.toFixed(2)}</strong> ×10⁻⁵ s⁻¹`,
          { sticky: true }
        );
        layers.push(circle);
      });
    } else {
      for (let i = 0; i < coords.length - 1; i++) {
        const s = points[i].strength * 1e5;
        const line = L.polyline(
          [[coords[i][1], coords[i][0]], [coords[i+1][1], coords[i+1][0]]],
          { color: getColor(s), weight: 4, opacity: 0.92 }
        ).bindTooltip(
          `<strong>AEW Segment</strong><br>Date: ${points[i].time.split(' ')[0]}<br>700hPa Curvature Vorticity: <strong>${s.toFixed(2)}</strong> ×10⁻⁵ s⁻¹`,
          { sticky: true }
        );
        layers.push(line);
      }
    }

    const group = L.featureGroup(layers).addTo(trackLayer);

    group.on('click', () => {
      if (currentHighlighted === group) return;

      // Reset previous
      if (currentHighlighted) {
        currentHighlighted.eachLayer(l => l.setStyle?.({ opacity: 0.92, fillOpacity: 0.98, weight: pointsOnly ? 0 : 4 }));
      }

      // Dim others
      trackLayer.eachLayer(g => {
        if (g !== group) {
          g.eachLayer(l => l.setStyle?.({ opacity: 0.5, fillOpacity: 0.5, weight: pointsOnly ? 0 : 2 }));
        }
      });

      // Highlight this one
      group.eachLayer(l => l.setStyle?.({
        weight: pointsOnly ? 0 : 8,
        opacity: 1, fillOpacity: 1,
        radius: pointsOnly ? 10 : undefined
      }));

      currentHighlighted = group;
    });
  });

  document.getElementById('trackCount').textContent = `${visible.length} tracks shown`;

  // Fixed: only call getBounds() if layer has content
  if (trackLayer.getLayers().length > 0) {
    try {
      map.fitBounds(trackLayer.getBounds().pad(0.3));
    } catch (e) {
      console.warn("getBounds failed (empty layer)", e);
    }
  }
}

function applyFilters() {
  if (dataLoaded) updateMap();
}

function clearFilters() {
  document.getElementById('monthFilter').value = 'all';
  document.getElementById('showPointsOnly').checked = false;
  if (dataLoaded) updateMap();
}

// Double-click to reset highlight
map.on('dblclick', () => {
  if (currentHighlighted && dataLoaded) {
    const pointsOnly = document.getElementById('showPointsOnly').checked;
    trackLayer.eachLayer(g => {
      g.eachLayer(l => l.setStyle?.({
        opacity: pointsOnly ? 0.98 : 0.92,
        fillOpacity: 0.98,
        weight: pointsOnly ? 0 : 4,
        radius: pointsOnly ? 7 : undefined
      }));
    });
    currentHighlighted = null;
  }
});
</script>

</body>
</html>